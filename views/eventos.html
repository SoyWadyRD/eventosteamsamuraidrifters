<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="../public/logo.ico" type="image/x-icon">
  <title>Eventos</title>
  <style>
    /* Reseteo global para evitar problemas de m√°rgenes y rellenos */
/* Reseteo global para evitar problemas de m√°rgenes y rellenos */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  overflow-x: hidden;
  background-color: #0a0a0a;
  color: #e0e0e0;
  font-family: 'Orbitron', sans-serif;
  scroll-behavior: smooth;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

h1 {
  text-align: center;
  font-size: 2.5rem;
  color: #0ff;
  margin-bottom: 30px;
  margin-top: 70px;
  text-shadow: 2px 2px 8px #000;
}

/* Contenedor principal de los eventos */
#eventos-lista {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  width: 100%;
  max-width: 1200px;
  box-sizing: border-box;
}

/* Contenedor de cada evento */
#eventos-lista div {
  background-color: #111;
  padding: 20px;
  border-radius: 15px;
  width: 260px; /* Fija el tama√±o de cada evento */
  box-shadow: 0 0 15px #0ff;
  text-align: center;
  transition: transform 0.3s ease;
  box-sizing: border-box; /* Asegura que el padding y borde no excedan el ancho */
}

/* Efecto hover en los eventos */
#eventos-lista div:hover {
  transform: translateY(-8px);
}

/* T√≠tulos de los eventos */
#eventos-lista h2 {
  font-size: 1.5rem;
  color: #0ff;
  margin-bottom: 10px;
  text-shadow: 1px 1px 5px #000;
}

/* Descripci√≥n de los eventos */
#eventos-lista p {
  font-size: 0.95rem;
  color: #ccc;
  margin-bottom: 8px;
  text-shadow: 1px 1px 3px #000;
}

/* Im√°genes de los eventos */
#eventos-lista img {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
  border: 2px solid #0ff;
  box-shadow: 0 0 10px #0ff;
}

/* Botones principales */
button {
  margin-top: 10px;
  padding: 10px 15px;
  background-color: #00f0ff;
  border: none;
  border-radius: 8px;
  color: #000;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  width: 100%;
}

button:hover {
  background-color: #0ff;
  box-shadow: 0 0 12px #0ff;
}

/* Contenedor de botones de admin ajustado */
.admin-buttons {
  margin-top: 15px;
  width: 260px; /* Igual al tama√±o de los eventos */
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-sizing: border-box;
  /* Centramos el contenedor de botones de admin */
  align-items: center;
  margin-left: 10px;
}

/* Botones de admin */
.admin-buttons button {
  width: 100%;
  box-sizing: border-box;
}

.ver-inscritos-btn {
  background-color: #25D366;
  color: white;
}

.ver-inscritos-btn:hover {
  background-color: #1ebc5e;
  box-shadow: 0 0 12px #25D366;
}

.eliminar-btn {
  background-color: #f44336;
  color: white;
}

.eliminar-btn:hover {
  background-color: #e53935;
  box-shadow: 0 0 12px #f44336;
}

/* Modal de inscritos */
#inscritos-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #111;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 0 20px #0ff;
  z-index: 1000;
  max-width: 400px;
  width: 90%;
  text-align: center;
}

#inscritos-modal h2 {
  color: #0ff;
  margin-bottom: 20px;
}

#inscritos-modal ul {
  list-style: none;
  padding: 0;
  margin-bottom: 20px;
}

#inscritos-modal li {
  padding: 5px 0;
  border-bottom: 1px solid #0ff;
}

#inscritos-modal button {
  background-color: #f44336;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 10px 15px;
  cursor: pointer;
  width: auto;
}

#inscritos-modal button:hover {
  background-color: #e53935;
  box-shadow: 0 0 10px #f44336;
}

/* Mensajes de √©xito o error */
.message {
  margin-top: 20px;
  padding: 10px;
  color: white;
  background-color: #333;
  border-radius: 5px;
  text-align: center;
  display: none;
}

.message.success {
  background-color: #4caf50;
}

.message.error {
  background-color: #f44336;
}







@media screen and (max-width: 2560px) {
  h1 {
    font-size: 2rem;
  }

  #eventos-lista {
    flex-direction: column;
    align-items: center;
  }

  #eventos-lista div {
    width: 90%;  /* Ajuste en m√≥vil */
    max-width: 360px;
    align-items: center;
  }

  .admin-buttons {
    width: 100%;  /* Ajuste en m√≥vil */
    align-items: center;
  }
}

/* Responsividad */
@media screen and (max-width: 768px) {
  h1 {
    font-size: 2rem;
  }

  #eventos-lista {
    flex-direction: column;
    align-items: center;
  }

  #eventos-lista div {
    width: 90%;  /* Ajuste en m√≥vil */
    max-width: 360px;
    align-items: center;
  }

  .admin-buttons {
    width: 100%;  /* Ajuste en m√≥vil */
    align-items: center;
  }
}







/* Estilo para el bot√≥n de "Crear Evento" */
.crear-evento-btn-container {
  display: none; /* Oculto por defecto */
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
}

.crear-evento-btn {
  background-color: #00f0ff;
  border: none;
  border-radius: 8px;
  color: #000;
  padding: 10px 20px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.crear-evento-btn:hover {
  background-color: #0ff;
  box-shadow: 0 0 12px #0ff;
}

.plus-symbol {
  font-size: 1.5rem;
  margin-right: 10px;
}















 /* Estilo del modal */
 #estado-salida-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 9999;
    }
    #estado-salida-modal h2 {
      margin: 0;
    }
    #cerrar-modal-btn {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }
    #cerrar-modal-btn:hover {
      background-color: #0056b3;
    }

  </style>
</head>

<body>

  <h1>Eventos</h1>


  <div class="crear-evento-btn-container">
    <button class="crear-evento-btn" onclick="window.location.href='/public/crear_evento.html'">
      <span class="plus-symbol">+</span> Crear Evento
    </button>
  </div>


  <div id="eventos-lista"></div>



  <!-- Modal de inscritos -->
  <div id="inscritos-modal">
    <h2>Lista de Inscritos</h2>
    <ul id="lista-inscritos"></ul>
    <button onclick="cerrarModal()" class="eliminar-evento-btn">Cerrar</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
  const contenedorEventos = document.getElementById('eventos-lista');

  try {
    const respuesta = await fetch('/events/eventos');
    const data = await respuesta.json();
    console.log('Datos de eventos:', data);

    const eventos = data.eventos || [];
    const usuarioId = data.usuarioId;
    const rol = data.rol;

    contenedorEventos.innerHTML = '';

    // Mostrar el bot√≥n "Crear Evento" solo si es admin
    if (rol === 'admin') {
      document.querySelector('.crear-evento-btn-container').style.display = 'block';
    }

    eventos.reverse().forEach(evento => {
      const eventoDiv = document.createElement('div');
      eventoDiv.classList.add('evento');
      eventoDiv.id = `evento-${evento._id}`; // ID √∫nico para cada evento

      let contenido = `
        <h2>${evento.titulo}</h2>
        <p>${evento.descripcion}</p>
        <p><strong>Fecha del evento:</strong> ${new Date(evento.fecha).toLocaleString()}</p>
        <p><strong>Fecha l√≠mite de inscripci√≥n:</strong> ${new Date(evento.fechaRegistroLimite).toLocaleString()}</p>
      `;

      if (evento.imagen) {
        contenido += `<img src="${evento.imagen}" alt="Imagen del evento">`;
      }

      const fechaLimite = new Date(evento.fechaRegistroLimite);
      const ahora = new Date();

      if (fechaLimite < ahora) {
        contenido += `<br><br><p style="color:red;">‚ùå Inscripciones cerradas</p><br>`;
      } else {
        if (evento.inscritos && evento.inscritos.includes(usuarioId)) {
          contenido += `
            <br><br><p style="color:green;">‚úÖ Ya est√°s inscrito</p><br>
            <button class="salir-btn" onclick="salir('${evento._id}')">Salir del Evento</button>
          `;
        } else {
          contenido += `
            <button class="inscribirse-btn" onclick="inscribirse('${evento._id}', '${usuarioId}')">Inscribirme</button>
          `;
        }
      }

      if (rol === 'admin') {
        contenido += `
          <div class="admin-buttons">
            <button class="ver-inscritos-btn" onclick="verInscritos('${evento._id}')">Ver Inscritos</button>
            <button class="eliminar-evento-btn" onclick="eliminarEvento('${evento._id}')">Eliminar Evento</button>
          </div>
        `;
      }

      eventoDiv.innerHTML = contenido;
      contenedorEventos.appendChild(eventoDiv);
    });
  } catch (error) {
    console.error('Error al cargar los eventos:', error);
    alert('Error al cargar los eventos.');
  }
});

// üßπ Funci√≥n mejorada para inscribirse con redirecci√≥n a login si no est√° logeado
async function inscribirse(eventoId) {
  try {
    const respuesta = await fetch(`/events/inscribir/${eventoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include' // ‚¨ÖÔ∏è MUY IMPORTANTE para enviar cookies de sesi√≥n
    });

    if (respuesta.status === 401) {
      alert('Debes iniciar sesi√≥n para inscribirte en un evento.');
      window.location.href = '/public/login.html';
      return;
    }

    const data = await respuesta.json();

    if (respuesta.ok) {
      alert(data.message);
      location.reload(); // ‚úÖ Esto recarga la p√°gina y ahora s√≠ el servidor devuelve el nuevo estado (inscrito)
    } else {
      alert(data.message);
    }
  } catch (error) {
    console.error('Error al inscribirse:', error);
    alert('Hubo un error al inscribirse. Intenta nuevamente.');
  }
}











// Funci√≥n para manejar la salida del evento
async function salir(eventoId) {
  try {
    const respuesta = await fetch(`/events/salir/${eventoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
    });

    const data = await respuesta.json();

    if (respuesta.ok) {
      alert('‚úÖ Has salido del evento correctamente.');
      location.reload(); // Recarga la p√°gina para actualizar el estado
    } else {
      alert(`‚ùå ${data.message || 'No se pudo salir del evento.'}`);
    }
  } catch (error) {
    console.error('Error al intentar salir del evento:', error);
    alert('‚ùå Error inesperado. Intenta nuevamente.');
  }
}










async function eliminarEvento(eventoId) {
  const confirmacion = confirm('¬øEst√°s seguro de que quieres eliminar este evento?');
  if (!confirmacion) return;

  try {
    const respuesta = await fetch(`/events/eliminar/${eventoId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
    });

    const data = await respuesta.json();
    if (respuesta.ok) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message);
    }
  } catch (error) {
    console.error('Error al eliminar el evento:', error);
    alert('Error al intentar eliminar el evento.');
  }
}

async function verInscritos(eventoId) {
  try {
    const respuesta = await fetch(`/events/inscritos/${eventoId}`);
    const data = await respuesta.json();

    if (respuesta.ok) {
      const lista = data.inscritos;
      const listaUl = document.getElementById('lista-inscritos');
      listaUl.innerHTML = '';

      if (lista.length === 0) {
        listaUl.innerHTML = '<li>No hay inscritos en este evento.</li>';
      } else {
        lista.forEach(nombre => {
          const li = document.createElement('li');
          li.textContent = nombre;
          listaUl.appendChild(li);
        });
      }

      document.getElementById('inscritos-modal').style.display = 'block';
    } else {
      alert(data.message || 'Error al obtener los inscritos');
    }
  } catch (error) {
    console.error('Error al obtener inscritos:', error);
    alert('Error al obtener los inscritos');
  }
}

function cerrarModal() {
  document.getElementById('inscritos-modal').style.display = 'none';
}

  </script>
</body>
</html>
